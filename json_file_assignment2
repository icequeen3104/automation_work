"""
Mini Project: Security Policy Validator Framework
Improved Version with Better JSON Error Handling
Features:
- Loads policies from JSON file
- Reads environment-based configuration
- Uses logging for validation tracking
- Handles exceptions gracefully
- Implements reusable validation rules using inheritance
"""

import json
import os
import logging
from collections import defaultdict


# Configuration

class Config:
    """Reads environment configuration."""

    def __init__(self):
        self.policy_file = os.getenv("POLICY_FILE", "policies.json")
        self.log_level = os.getenv("LOG_LEVEL", "INFO").upper()


# Logger Setup

def setup_logger(level):
    """Configure logging format and level."""
    logging.basicConfig(
        level=getattr(logging, level, logging.INFO),
        format="%(asctime)s - %(levelname)s - %(message)s"
    )

# Base Validator

class BaseValidator:
    """Base class for all validators."""

    def validate(self, policy):
        raise NotImplementedError("Subclasses must implement validate()")

# Validators

class RequiredFieldValidator(BaseValidator):
    REQUIRED_FIELDS = ["policy_id", "name", "enabled", "min_length", "max_attempts"]

    def validate(self, policy):
        errors = []
        for field in self.REQUIRED_FIELDS:
            if field not in policy:
                errors.append(f"Missing field: {field}")
        return errors


class NameValidator(BaseValidator):
    def validate(self, policy):
        if not policy.get("name", "").strip():
            return ["Name is empty"]
        return []


class EnabledValidator(BaseValidator):
    def validate(self, policy):
        if not isinstance(policy.get("enabled"), bool):
            return ["Enabled is not boolean"]
        return []


class MinLengthValidator(BaseValidator):
    def validate(self, policy):
        if policy.get("min_length", 0) < 6:
            return ["min_length < 6"]
        return []


class MaxAttemptsValidator(BaseValidator):
    def validate(self, policy):
        if policy.get("max_attempts", 0) <= 0:
            return ["max_attempts <= 0"]
        return []


# Framework


class PolicyValidator:
    """Main validation framework."""

    def __init__(self, validators):
        self.validators = validators

    def load_policies(self, filepath):
        """Load JSON policies safely."""
        if not os.path.exists(filepath):
            logging.error(f"Policy file not found: {filepath}")
            return []

        try:
            with open(filepath, "r") as file:
                policies = json.load(file)
                logging.info("Policies loaded successfully.")
                return policies
        except json.JSONDecodeError as e:
            logging.error(f"Invalid JSON format at line {e.lineno}: {e.msg}")
            return []
        except Exception as e:
            logging.error(f"Unexpected error while reading file: {e}")
            return []

    def validate(self, policies):
        """Run all validations."""
        errors = defaultdict(list)
        id_count = defaultdict(int)

        # Count policy_id occurrences
        for policy in policies:
            pid = policy.get("policy_id")
            if pid:
                id_count[pid] += 1

        # Validate each policy
        for policy in policies:
            pid = policy.get("policy_id", "UNKNOWN")

            # Run rule validators
            for validator in self.validators:
                result = validator.validate(policy)
                for issue in result:
                    if issue not in errors[pid]:
                        errors[pid].append(issue)

            # Duplicate check (only once per ID)
            if id_count[pid] > 1 and "Duplicate policy_id" not in errors[pid]:
                errors[pid].append("Duplicate policy_id")

        return errors


# Main

def main():
    """
        Main function that:
        - Initializes configuration
        - Sets up logging
        - Loads policies
        - Runs validations
        - Prints summary report
        """

    config = Config()
    setup_logger(config.log_level)

    validators = [
        RequiredFieldValidator(),
        NameValidator(),
        EnabledValidator(),
        MinLengthValidator(),
        MaxAttemptsValidator()
    ]

    framework = PolicyValidator(validators)

    policies = framework.load_policies(config.policy_file)

    validation_results = framework.validate(policies)

    if not validation_results:
        print("No validation results.")
        return

    # Collect all unique policy IDs from the policies list
    all_ids = set()
    for policy in policies:
        pid = policy.get("policy_id")
        if pid:
            all_ids.add(pid)

    valid = []
    invalid = []

    # Check each policy ID
    for pid in all_ids:
        if pid in validation_results and validation_results[pid]:
            invalid.append(pid)
        else:
            valid.append(pid)

    # Print results
    print("\nValid policies:", ", ".join(valid))
    print("Invalid policies:", ", ".join(invalid))
    print("Errors:")
    for pid, issues in validation_results.items():
        for issue in issues:
            print(f"- {pid}: {issue}")

if __name__ == "__main__":
    main()
